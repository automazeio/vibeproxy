name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual trigger

jobs:
  build:
    name: Build macOS App
    runs-on: macos-13  # macOS Ventura
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "5.9"
      
      - name: Install dependencies
        run: |
          # Add any dependencies needed for build
          echo "Installing build dependencies..."
      
      - name: Build app bundle
        run: |
          chmod +x build.sh create-app-bundle.sh
          ./create-app-bundle.sh
      
      - name: Create DMG (optional)
        run: |
          # Install create-dmg tool
          brew install create-dmg
          
          # Create DMG
          create-dmg \
            --volname "VibeProxy" \
            --volicon "icon.png" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "VibeProxy.app" 175 120 \
            --hide-extension "VibeProxy.app" \
            --app-drop-link 425 120 \
            "VibeProxy.dmg" \
            "VibeProxy.app" || true
      
      - name: Create ZIP archive
        run: |
          # ZIP is more reliable for GitHub releases
          ditto -c -k --sequesterRsrc --keepParent "VibeProxy.app" "VibeProxy.zip"
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            VibeProxy.zip
            VibeProxy.dmg
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## VibeProxy ${{ steps.get_version.outputs.VERSION }}
            
            ### Installation
            
            1. Download `VibeProxy.zip` (recommended) or `VibeProxy.dmg`
            2. Extract/mount the file
            3. Drag `VibeProxy.app` to your `/Applications` folder
            4. **First launch**: Right-click â†’ Open (to bypass Gatekeeper)
            5. Subsequent launches: Double-click as normal
            
            ### What's New
            
            See the [CHANGELOG](https://github.com/automazeio/proxybar/blob/main/CHANGELOG.md) for details.
            
            ---
            
            **Note**: This is an ad-hoc signed build. macOS will show a warning on first launch. This is normal for open-source apps.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifact (for manual downloads)
        uses: actions/upload-artifact@v3
        with:
          name: VibeProxy-macOS
          path: VibeProxy.zip
          retention-days: 30
